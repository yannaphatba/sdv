# 1. Database Storage (Persistent Volume Claim)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
  namespace: sdv
spec:
  accessModes: [ReadWriteOnce]
  resources: { requests: { storage: 2Gi } }
---
# 2. MySQL Service (Internal)
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
  namespace: sdv
spec:
  ports: [{ port: 3306 }]
  selector: { app: mysql }
---
# 3. MySQL Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: sdv
spec:
  selector: { matchLabels: { app: mysql } }
  template:
    metadata: { labels: { app: mysql } }
    spec:
      containers:
      - name: php-nginx
        image: ghcr.io/yannaphatba/sdv:placeholder
        imagePullPolicy: Always
        resources:
          requests: 
            cpu: "250m"
            memory: "512Mi"  
          limits: 
            cpu: "500m"
            memory: "1Gi"   
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "mydbpassword"
        - name: MYSQL_DATABASE
          value: "mydb"
        ports: [{ containerPort: 3306 }]
        volumeMounts:
        - name: data
          mountPath: /var/lib/mysql
      volumes:
      - name: data
        persistentVolumeClaim: { claimName: mysql-pvc }
---
# 4. PHP-Nginx Application Service
apiVersion: v1
kind: Service
metadata:
  name: php-service
  namespace: sdv
spec:
  ports: [{ port: 80 }]
  selector: { app: php }
---
# [ส่วนที่ 1-4 เหมือนเดิมของริวครับ]

# 5. PHP-Nginx Application Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: php-app
  namespace: sdv
spec:
  selector: { matchLabels: { app: php } }
  template:
    metadata: { labels: { app: php } }
    spec:
      containers:
      - name: php-nginx
        # ใส่ placeholder ไว้ให้ตรงกับที่ในไฟล์ .github/workflows/deploy.yml จะมา sed เปลี่ยนนะครับ
        image: ghcr.io/yannaphatba/sdv:placeholder
        imagePullPolicy: Always
        resources:
          requests: { cpu: "250m", memory: "256Mi" }
          limits: { cpu: "500m", memory: "512Mi" }
        ports: [{ containerPort: 80 }]
        env:
        - name: DB_CONNECTION
          value: "mysql"
        - name: DB_HOST
          value: "mysql-service"
        - name: DB_DATABASE
          value: "mydb"
        - name: DB_USERNAME
          value: "root"
        - name: DB_PASSWORD
          value: "mydbpassword"
---
# 6. Ingress (Web Access)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: php-ingress
  namespace: sdv
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web
    # เพิ่มบรรทัดนี้เพื่อให้เข้าผ่าน /sdv ได้สมบูรณ์
    traefik.ingress.kubernetes.io/router.middlewares: sdv-stripprefix@kubernetescrd
spec:
  ingressClassName: traefik
  rules:
  - host: project.cpe.rmuti.ac.th
    http:
      paths:
      - path: /sdv
        pathType: Prefix
        backend:
          service:
            name: php-service
            port: { number: 80 }